<!DOCTYPE html>
<!--
  ~ Copyright 2012 Alexander Orlov <alexander.orlov@loxal.net>. All rights reserved.
  ~ Use of this source code is governed by a BSD-style
  ~ license that can be found in the LICENSE file.
  -->
<title>MAIN</title>

<h1>MAIN</h1>

<div id="uiTest"></div>
<script type="application/dart" src="uitest/main.dart"></script>
<script src="http://dart.googlecode.com/svn/branches/bleeding_edge/dart/client/dart.js"></script>


<!--/*-->
<!--(c) Copyright 2009 iOpus Software GmbH - http://www.iopus.com-->
<!--*/-->



<!--// play-button click handler-->
<!--function play() {-->
    <!--if ($("play-button").getAttribute("disabled") == "true")-->
        <!--return;-->
    <!--try {-->
        <!--var win_id = args.win_id;-->
        <!--var bg = chrome.extension.getBackgroundPage();-->
        <!--var mplayer = bg.context[win_id].mplayer;-->
        <!--var doc = window.frames["tree-iframe"].document;-->
        <!--var container = doc.getElementById("imacros-macro-container");-->
        <!--var div = doc.getElementById("imacros-bookmark-div");-->
        <!--var macro = {};-->

        <!--if (div.hasAttribute("file_id")) {-->
            <!--try {-->
                <!--var node = im_FIO.openNode(div.getAttribute("file_id"));-->
                <!--macro.source = im_FIO.readTextFile(node);-->
                <!--macro.file_id = div.getAttribute("file_id");-->
            <!--} catch (e) {-->
                <!--alert("Can not open "+container.value+-->
                      <!--", reason: "+e.toString());-->
                <!--console.error(e.toString());-->
                <!--return;-->
            <!--}-->
        <!--} else if (div.hasAttribute("bookmark_id")) {-->
            <!--macro.source = container.value;-->
            <!--macro.bookmark_id = div.getAttribute("bookmark_id");-->
        <!--}-->

        <!--macro.name = div.getAttribute("name");-->
        <!--if (mplayer.paused) {-->
            <!--mplayer.unpause();-->
        <!--} else {-->
            <!--mplayer.play(macro);-->
        <!--}-->
    <!--} catch (e) {-->
        <!--console.error(e.toString());-->
    <!--}-->
<!--}-->

<!--function playLoop() {-->
    <!--var cur = parseInt($("current-loop").value);-->
    <!--var max = parseInt($("max-loop").value);-->
    <!--if (cur > max) {-->
        <!--alert("Current loop value should be less or equivalent max loop value");-->
        <!--return;-->
    <!--}-->
    <!--try {-->
        <!--var win_id = args.win_id;-->
        <!--var bg = chrome.extension.getBackgroundPage();-->
        <!--var mplayer = bg.context[win_id].mplayer;-->
        <!--var doc = window.frames["tree-iframe"].document;-->
        <!--var container = doc.getElementById("imacros-macro-container");-->
        <!--var div = doc.getElementById("imacros-bookmark-div");-->
        <!--var macro = {name: div.getAttribute("name")};-->
        <!--if (div.hasAttribute("file_id")) {-->
            <!--try {-->
                <!--var node = im_FIO.openNode(div.getAttribute("file_id"));-->
                <!--macro.source = im_FIO.readTextFile(node);-->
                <!--macro.file_id = div.getAttribute("file_id");-->
            <!--} catch (e) {-->
                <!--alert("Can not open "+container.value+-->
                      <!--", reason: "+e.toString());-->
                <!--console.error(e.toString());-->
                <!--return;-->
            <!--}-->
        <!--} else if (div.hasAttribute("bookmark_id")) {-->
            <!--macro.source = container.value;-->
        <!--}-->

        <!--mplayer.play(macro, max, cur);-->
    <!--} catch (e) {-->
        <!--console.error(e.toString());-->
    <!--}-->
<!--}-->

<!--// Pause button handler-->
<!--function pause() {-->
    <!--try {-->
        <!--var win_id = args.win_id;-->
        <!--var bg = chrome.extension.getBackgroundPage();-->
        <!--var mplayer = bg.context[win_id].mplayer;-->
        <!--if (mplayer.playing) {-->
            <!--mplayer.pause();-->
        <!--}-->
    <!--} catch (e) {-->
        <!--console.error(e.toString());-->
    <!--}-->
<!--}-->

<!--// Edit button handler-->
<!--function edit() {-->
    <!--if ($("edit-button").getAttribute("disabled") == "true")-->
        <!--return;-->
    <!--var bg = chrome.extension.getBackgroundPage();-->
    <!--var doc = window.frames["tree-iframe"].document;-->
    <!--var container = doc.getElementById("imacros-macro-container");-->
    <!--var div = doc.getElementById("imacros-bookmark-div");-->
    <!--var source = "", name = div.getAttribute("name");-->
    <!--var macro = {name: name, win_id: args.win_id};-->

    <!--if (div.hasAttribute("file_id")) {-->
        <!--var file_id = div.getAttribute("file_id");-->
        <!--try {-->
            <!--var node = im_FIO.openNode(file_id);-->
            <!--source = im_FIO.readTextFile(node);-->
        <!--} catch (e) {-->
            <!--alert("Can not open "+container.value+-->
                  <!--", reason: "+e.toString());-->
            <!--console.error(e.toString());-->
            <!--return;-->
        <!--}-->
        <!--macro.source = source;-->
        <!--macro.file_id = file_id;-->
        <!--bg.edit(macro, true);-->
    <!--} else if (div.hasAttribute("bookmark_id")) {-->
        <!--source = container.value;-->
        <!--var bookmark_id = div.getAttribute("bookmark_id");-->
        <!--macro.source = source;-->
        <!--macro.bookmark_id = bookmark_id;-->
        <!--bg.edit(macro, true);-->
    <!--}-->
<!--}-->


<!--// Record button handler-->
<!--function record() {-->
    <!--var win_id = args.win_id;-->
    <!--var bg = chrome.extension.getBackgroundPage();-->
    <!--var recorder = bg.context[win_id].recorder;-->
    <!--try {-->
        <!--recorder.start();-->
    <!--} catch (e) {-->
        <!--console.error(e.toString());-->
    <!--}-->
<!--}-->

<!--// Stop button handler-->
<!--function stop() {-->
    <!--var win_id = args.win_id;-->
    <!--var bg = chrome.extension.getBackgroundPage();-->

    <!--var mplayer = bg.context[win_id].mplayer;-->
    <!--var recorder = bg.context[win_id].recorder;-->

    <!--try {-->
        <!--if (mplayer.playing) {-->
            <!--mplayer.stop();-->
        <!--} else if (recorder.recording) {-->
            <!--recorder.stop();-->
            <!--var recorded_macro = recorder.actions.join("\n");-->

            <!--var macro = {source: recorded_macro, win_id: win_id,-->
                         <!--name: "#Current.iim"};-->

            <!--if (Storage.getChar("tree-type") == "files") {-->
                <!--if (im_FIO.openNode) {-->
                    <!--var node = im_FIO.getDefaultDir("savepath");-->
                    <!--node.append("#Current.iim");-->
                    <!--macro.file_id = node.path;-->
                    <!--bg.edit(macro, /* overwrite */ true);-->
                <!--} else {            // no file access-->
                    <!--bg.edit(macro, true);-->
                <!--}-->
            <!--} else {-->
                <!--bg.edit(macro, true);-->
            <!--}-->
        <!--}-->
    <!--} catch (e) {-->
        <!--console.error(e.toString());-->
    <!--}-->
<!--}-->


<!--// called when a macro is selected in tree-view-->
<!--function onSelectionChanged(selected) {-->
    <!--var disable = function (btns) {-->
        <!--for (var x = 0; x < arguments.length; x++) {-->
            <!--var b = $(arguments[x]+"-button");-->
            <!--b.setAttribute("disabled", "true");-->
            <!--var title = b.getAttribute("title");-->
            <!--b.setAttribute("origtitle", title);-->
            <!--b.setAttribute("title", "Choose macro to activate button");-->
        <!--}-->
    <!--};-->
    <!--var enable = function (btns) {-->
        <!--for (var x = 0; x < arguments.length; x++) {-->
            <!--var b = $(arguments[x]+"-button");-->
            <!--b.setAttribute("disabled", "false");-->
            <!--var title = b.getAttribute("origtitle");-->
            <!--b.setAttribute("title", title);-->
        <!--}-->
    <!--};-->

    <!--// change 'disabled' status of buttons-->
    <!--if (selected) {-->
        <!--enable("play", "loop", "edit");-->
    <!--} else {-->
        <!--disable("play", "loop", "edit");-->
    <!--}-->
<!--}-->


<!--function updatePanel(state) {-->
    <!--var show = function (btns) {-->
        <!--for (var x = 0; x < arguments.length; x++) {-->
            <!--$(arguments[x]+"-button").setAttribute("collapsed", "false");-->
        <!--}-->
    <!--};-->
    <!--var hide = function (btns) {-->
        <!--for (var x = 0; x < arguments.length; x++) {-->
            <!--$(arguments[x]+"-button").setAttribute("collapsed", "true");-->
        <!--}-->
    <!--};-->
    <!--switch(state) {-->
    <!--case "playing":-->
        <!--show("pause", "stop");-->
        <!--hide("play", "record");-->
        <!--break;-->
    <!--case "paused":-->
        <!--// TODO: change tooltip for Play button-->
        <!--show("play", "stop");-->
        <!--hide("pause", "record");-->
        <!--break;-->
    <!--case "recording":-->
        <!--show("stop");-->
        <!--hide("pause", "record", "play");-->
        <!--break;-->
    <!--case "idle":-->
        <!--show("play", "record");-->
        <!--hide("stop", "pause");-->
        <!--break;-->
    <!--}-->

<!--}-->


<!--function onTreeSelect(type) {-->
    <!--Storage.setChar("tree-type", type);-->
    <!--var tree_iframe = $("tree-iframe");-->
    <!--if (type == "files") {-->
        <!--$("radio-files-tree").checked="yes";-->
        <!--tree_iframe.src = "fileView.html";-->
    <!--} else if (type == "bookmarks") {-->
        <!--tree_iframe.src = "treeView.html";-->
        <!--$("radio-bookmarks-tree").checked="yes";-->
    <!--}-->
<!--}-->


<!--window.addEventListener("load", function() {-->
    <!--var tree_type = Storage.isSet("tree-type") ?-->
        <!--Storage.getChar("tree-type") : "files";-->
    <!--window.im_FIO = $("imacros-fio-plugin");-->
    <!--if (!/^(?:files|bookmarks)$/.test(tree_type)) {-->
        <!--if (im_FIO && im_FIO.openNode)-->
            <!--tree_type = "files";-->
        <!--else-->
            <!--tree_type = "bookmarks"-->
    <!--}-->

    <!--if (tree_type == "files" && im_FIO && im_FIO.openNode) {-->
        <!--onTreeSelect("files");-->
    <!--} else {-->
        <!--onTreeSelect("bookmarks");-->
    <!--}-->

<!--});-->


<!--function checkNumberKey(e) {-->
    <!--var char = String.fromCharCode(e.which)-->
    <!--return /\d/.test(char)-->
<!--}-->

<!--function setLoopValue(val) {-->
    <!--$("current-loop").value = val;-->
<!--}-->


<!--// convert bookmarklet-type macro to file or vice versa-->
<!--function convert() {-->

    <!--try {-->
        <!--var win_id = args.win_id;-->
        <!--var bg = chrome.extension.getBackgroundPage();-->
        <!--var doc = window.frames["tree-iframe"].document;-->
        <!--var container = doc.getElementById("imacros-macro-container");-->
        <!--var div = doc.getElementById("imacros-bookmark-div");-->
        <!--var macro = {};-->
        <!--var type;-->

        <!--if (!im_FIO || !im_FIO.openNode) {-->
            <!--alert("Can not instantiate file object plug-in!");-->
            <!--return;-->
        <!--}-->

        <!--if (div.hasAttribute("file_id")) {-->
            <!--// convert file to bookmarklet-->
            <!--type = "bookmark";-->
            <!--try {-->
                <!--var node = im_FIO.openNode(div.getAttribute("file_id"));-->
                <!--macro.source = im_FIO.readTextFile(node);-->
                <!--macro.name = div.getAttribute("name");-->
            <!--} catch (e) {-->
                <!--alert("Can not open "+container.value+-->
                      <!--", reason: "+e.toString());-->
                <!--console.error(e.toString());-->
                <!--return;-->
            <!--}-->
        <!--} else if (div.hasAttribute("bookmark_id")) {-->
            <!--type = "file";-->
            <!--// convert bookmarklet to file-->
            <!--macro.source = container.value;-->
            <!--macro.name = div.getAttribute("name");-->
            <!--if (!/\.iim$/.test(name)) // append .iim extension-->
                <!--macro.name += ".iim";-->
            <!--var node = im_FIO.getDefaultDir("savepath");-->
            <!--node.append(macro.name);-->
            <!--macro.file_id = node.path;-->
        <!--}-->

        <!--bg.save(macro, false);-->
        <!--alert("Macro duplicated in "+type+" storage");-->

    <!--} catch (e) {-->
        <!--console.error(e.toString());-->
    <!--}-->
<!--}-->




<!--function showLines(code) {-->
    <!--$("tree-view").setAttribute("hidden", "true");-->
    <!--$("macro-view").removeAttribute("hidden");-->
    <!--if (code && code.length) {-->
        <!--$("macro-iframe").contentWindow.mv.showLines(code);-->
    <!--} else {-->
        <!--$("macro-iframe").contentWindow.mv.clearAllLines();-->
    <!--}-->
<!--}-->

<!--function showMacroTree() {-->
    <!--$("tree-view").removeAttribute("hidden");-->
    <!--$("macro-view").setAttribute("hidden", "true");-->
<!--}-->

<!--function addLine(txt) {-->
    <!--$("macro-iframe").contentWindow.mv.addLine(txt);-->
<!--}-->

<!--function highlightLine(line) {-->
    <!--$("macro-iframe").contentWindow.mv.highlightLine(line);-->
<!--}-->

<!--function setStatLine(txt, type) {-->
    <!--$("macro-iframe").contentWindow.mv.setStatLine(txt, type);-->
<!--}-->

<!--function removeLastLine() {-->
    <!--$("macro-iframe").contentWindow.mv.removeLastLine();-->
<!--}-->


<!--var info_args = null;-->

<!--function showInfo(args) {-->
    <!--info_args = args;-->
    <!--var info_div = $("info-div");-->
    <!--info_div.removeAttribute("hidden");-->
    <!--$("logo-and-links").setAttribute("hidden", "true");-->

    <!--if (args.errorCode != 1) {-->
        <!--$("info-area").setAttribute("type", "error");-->
        <!--$("info-edit-button").removeAttribute("collapsed");-->
        <!--$("info-help-button").removeAttribute("collapsed");-->
    <!--} else {-->
        <!--$("info-area").setAttribute("type", "message");-->
        <!--$("info-edit-button").setAttribute("collapsed", "true");-->
        <!--$("info-help-button").setAttribute("collapsed", "true");-->
    <!--}-->

    <!--$("info-area").textContent = args.message;-->
<!--}-->

<!--function onInfoClose() {-->
    <!--$("info-div").setAttribute("hidden", "true");-->
    <!--$("logo-and-links").removeAttribute("hidden");-->
<!--}-->


<!--function onInfoHelp() {-->
    <!--var url = "http://www.iopus.com/imacros/home/fx/e.asp?browser=cr&error="-->
        <!--+info_args.errorCode;-->
    <!--var bg = chrome.extension.getBackgroundPage();-->
    <!--bg.addTab(url, info_args.win_id);-->
<!--}-->

<!--function onInfoEdit() {-->
    <!--// TODO: pass line number to editor-->
    <!--// var line = 0;-->
    <!--// if (/, line:\s*(\d+)(?:\s+\(.*\))?$/.test(info_args.message))-->
    <!--//     line = parseInt(RegExp.$1);-->
    <!--var bg = chrome.extension.getBackgroundPage();-->
    <!--bg.edit(info_args.macro, true);-->
<!--}-->